name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build Frontend
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update package.json version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Update version in package.json
          cat package.json | jq --arg ver "$VERSION" '.version = $ver' > package.json.tmp
          mv package.json.tmp package.json
          echo "Updated package.json to version $VERSION"

      - name: Install dependencies
        run: bun install

      - name: Build frontend
        run: bun run build

      - name: Create version.json
        run: |
          cat > dist/version.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}"
          }
          EOF
          cat dist/version.json

      - name: Create files manifest
        run: |
          cd dist
          # Create a list of all files for autodiscovery
          find . -type f | sed 's|^\./||' | sort > files
          echo "Created files manifest:"
          cat files

      - name: Create distribution archive
        run: |
          tar -czf dist.tar.gz -C dist .
          ls -lh dist.tar.gz

      - name: Create and push version branch
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH_NAME="v${VERSION}"

          echo "Creating branch: $BRANCH_NAME"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create orphan branch (no history, clean slate)
          git checkout --orphan "$BRANCH_NAME"

          # Remove all files from git index
          git rm -rf .

          # Copy dist contents to root
          cp -r dist/* .

          # Add only the dist files
          git add .

          # Commit
          git commit -m "Release v${VERSION} - Built frontend distribution"

          # Force push (overwrites if branch exists)
          git push origin "$BRANCH_NAME" --force

          echo "Branch $BRANCH_NAME created and pushed successfully"
          echo "Files available at: https://raw.githubusercontent.com/${{ github.repository }}/$BRANCH_NAME/files"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: rx-viewer-${{ steps.version.outputs.version }}
          path: dist.tar.gz
          retention-days: 90

      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## RX Viewer v${{ steps.version.outputs.version }}

            Web-based frontend for RX (Regex Tracer).

            ### Installation Methods

            #### Method 1: GitHub Release (Recommended)
            ```bash
            # Download and extract from release assets
            mkdir -p ~/.cache/rx/frontend
            curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/dist.tar.gz | tar -xz -C ~/.cache/rx/frontend
            ```

            #### Method 2: Raw GitHub Content (No API rate limits)
            ```bash
            # Download individual files from version branch
            VERSION="${{ steps.version.outputs.version }}"
            BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/v${VERSION}"

            mkdir -p ~/.cache/rx/frontend
            cd ~/.cache/rx/frontend

            # Get file list
            curl -sL "$BASE_URL/files" -o files

            # Download all files
            while IFS= read -r file; do
              mkdir -p "$(dirname "$file")"
              curl -sL "$BASE_URL/$file" -o "$file"
            done < files
            ```

            ### What's Included

            - Built frontend (HTML, JS, CSS)
            - Version metadata (`version.json`)
            - File manifest (`files`) for autodiscovery
            - Source maps for debugging

            ### Backends Compatible With This Version

            - rx-tool (Python) >= 1.4.0
            - rx-tool-go >= 1.0.0

            ### Distribution Files

            - `dist.tar.gz` - Complete frontend distribution (release asset)
            - Branch `v${{ steps.version.outputs.version }}` - Individual files accessible via raw.githubusercontent.com

      - name: Create Release (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: dist.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## RX Viewer v${{ steps.version.outputs.version }}

            Web-based frontend for RX (Regex Tracer).

            **Note**: This is a manually triggered release.

            ### Installation Methods

            #### Method 1: GitHub Release (Recommended)
            ```bash
            # Download and extract from release assets
            mkdir -p ~/.cache/rx/frontend
            curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/dist.tar.gz | tar -xz -C ~/.cache/rx/frontend
            ```

            #### Method 2: Raw GitHub Content (No API rate limits)
            ```bash
            # Download individual files from version branch
            VERSION="${{ steps.version.outputs.version }}"
            BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/v${VERSION}"

            mkdir -p ~/.cache/rx/frontend
            cd ~/.cache/rx/frontend

            # Get file list
            curl -sL "$BASE_URL/files" -o files

            # Download all files
            while IFS= read -r file; do
              mkdir -p "$(dirname "$file")"
              curl -sL "$BASE_URL/$file" -o "$file"
            done < files
            ```

  verify:
    name: Verify Build
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: rx-viewer-${{ needs.build.outputs.version }}

      - name: Extract and verify
        run: |
          mkdir -p extracted
          tar -xzf dist.tar.gz -C extracted

          echo "Verifying build contents..."

          # Check required files
          if [ ! -f extracted/index.html ]; then
            echo "ERROR: index.html not found"
            exit 1
          fi

          if [ ! -f extracted/version.json ]; then
            echo "ERROR: version.json not found"
            exit 1
          fi

          if [ ! -d extracted/assets ]; then
            echo "ERROR: assets directory not found"
            exit 1
          fi

          echo "âœ“ All required files present"

          # Display version info
          echo ""
          echo "Version info:"
          cat extracted/version.json | jq .

          # Count files
          FILE_COUNT=$(find extracted -type f | wc -l)
          echo ""
          echo "Total files: $FILE_COUNT"

          # Check size
          TOTAL_SIZE=$(du -sh extracted | cut -f1)
          echo "Total size: $TOTAL_SIZE"
